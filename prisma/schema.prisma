generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Enums ============
enum LoginReason {
  NORMAL
  SUPERVISOR
  ADMIN_OVERRIDE
}

model Company {
  id        String     @id @default(cuid())
  name      String
  createdAt DateTime   @default(now())

  employees Employee[]
  devices   Device[]
  workShifts WorkShift[]
}

model Employee {
  id           String   @id @default(cuid())
  companyId    String
  employeeCode String
  fullName     String
  password     String
  createdAt    DateTime @default(now())

  company              Company                   @relation(fields: [companyId], references: [id])
  sessions             Session[]
  shiftAssignments     EmployeeShiftAssignment[]
  deviceLoginEvents    DeviceLoginEvent[]
  dailyStats           EmployeeDailyStats[]

  @@unique([companyId, employeeCode])
}

// ============ WorkShift: الشيفت المجدول (وليس الجلسة الفعلية) ============
model WorkShift {
  id        String   @id @default(cuid())
  companyId String
  name      String   // Morning / Evening / Night
  startTime String   // "08:00"
  endTime   String   // "16:00"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  company   Company                   @relation(fields: [companyId], references: [id])
  assignments EmployeeShiftAssignment[]

  @@index([companyId])
}

// ============ EmployeeShiftAssignment: ربط الموظف بالشيفت ============
model EmployeeShiftAssignment {
  id          String    @id @default(cuid())
  employeeId  String
  shiftId     String
  assignedFrom DateTime
  assignedTo   DateTime? // nullable = لا يزال معينًا

  employee Employee @relation(fields: [employeeId], references: [id])
  shift    WorkShift @relation(fields: [shiftId], references: [id])

  @@index([employeeId])
  @@index([shiftId])
  @@index([employeeId, assignedFrom])
}

model Device {
  id               String   @id @default(cuid())
  companyId        String
  deviceIdentifier String   @unique
  deviceName       String
  createdAt        DateTime @default(now())
  isOnline         Boolean  @default(false)
  lastSeenAt       DateTime?

  company          Company           @relation(fields: [companyId], references: [id])
  sessions         Session[]
  deviceLoginEvents DeviceLoginEvent[]

  @@index([companyId])
}

// ============ Session: Device Session فقط (من boot إلى shutdown) ============
// تمثل تشغيل الجهاز - لا ترتبط بموظف واحد فقط (الربط عبر DeviceLoginEvent)
model Session {
  id                 String    @id @default(cuid())
  employeeId         String?   // optional: null = نظام يعمل بدون موظف مسجل
  deviceId           String
  loginTime          DateTime  @default(now())
  logoutTime         DateTime?
  totalActiveSeconds Int       @default(0)
  totalIdleSeconds   Int       @default(0)
  status             String    @default("ACTIVE")

  // Device Session fields
  deviceBootAt     DateTime?  // وقت تشغيل الجهاز
  deviceShutdownAt DateTime?  // وقت إيقاف الجهاز
  isSystemSession  Boolean    @default(false) // true = الجهاز يعمل بدون موظف

  employee    Employee?          @relation(fields: [employeeId], references: [id])
  device      Device            @relation(fields: [deviceId], references: [id])
  activities  Activity[]
  idleLogs    IdleLog[]
  screenshots Screenshot[]
  deviceLoginEvents DeviceLoginEvent[]

  @@index([deviceId])
  @@index([deviceId, loginTime])
}

// ============ DeviceLoginEvent: تسجيل دخول/خروج الموظف على الجهاز ============
// يسمح بـ: تبديل موظفين، معرفة من كان على الجهاز، حساب زمن كل موظف بدقة
// لا تداخل: لا يسمح بتداخل LoginEvent لنفس الجهاز
model DeviceLoginEvent {
  id         String     @id @default(cuid())
  deviceId   String
  employeeId String
  sessionId  String     // الجلسة (Device Session) التي حدث فيها الدخول
  loginAt    DateTime
  logoutAt   DateTime?
  reason     LoginReason @default(NORMAL) // NORMAL | SUPERVISOR | ADMIN_OVERRIDE
  createdAt  DateTime   @default(now())

  device  Device  @relation(fields: [deviceId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])
  session Session @relation(fields: [sessionId], references: [id])

  @@index([deviceId, loginAt])
  @@index([employeeId, loginAt])
  @@index([sessionId])
}

model Activity {
  id              String   @id @default(cuid())
  sessionId       String
  appName         String
  windowTitle     String
  url             String?
  category        String?
  startTime       DateTime
  endTime         DateTime
  durationSeconds Int

  session Session @relation(fields: [sessionId], references: [id])
}

model IdleLog {
  id              String   @id @default(cuid())
  sessionId       String
  startTime       DateTime
  endTime         DateTime
  durationSeconds Int

  session Session @relation(fields: [sessionId], references: [id])
}

model Screenshot {
  id         String   @id @default(cuid())
  sessionId  String
  filePath   String
  capturedAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id])
}

// ============ EmployeeDailyStats: Snapshot للمقاييس اليومية ============
// يستخدم للـ Dashboard بدل حساب مباشر ثقيل
model EmployeeDailyStats {
  id                  String   @id @default(cuid())
  employeeId          String
  date                DateTime @db.Date
  totalWorkSeconds    Int      @default(0)
  totalActiveSeconds  Int      @default(0)
  totalIdleSeconds    Int      @default(0)
  shiftSeconds        Int      @default(0)      // وقت داخل الشيفت
  outsideShiftSeconds Int      @default(0)      // وقت خارج الشيفت
  riskScore           Float?
  productivityScore   Float?

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([employeeId, date])
}